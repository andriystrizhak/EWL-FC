using Eng_Flash_Cards_Learner.EF_SQLite;
using System.Data.SQLite;
using NUnit.Framework;
using Eng_Flash_Cards_Learner;
using SQLitePCL;

namespace EWL_Tests
{
    /*
    /// <summary>
    /// Клас що містить тест-кейси
    /// </summary>
    public static class MyTestCases
    {
        /// <summary>
        /// Набір тест-кейсів з Категоріями
        /// </summary>
        /// <returns> IEnumerable категорій </returns>
        public static IEnumerable<TestCaseData> Categories_Cases()
        {
            yield return new TestCaseData("Category 1");
            yield return new TestCaseData("Category 2");
        }

        /// <summary>
        /// Набір тест-кейсів зі Словами
        /// </summary>
        /// <returns> IEnumerable слів </returns>
        public static IEnumerable<TestCaseData> Words_Cases()
        {
            yield return new TestCaseData("a", "ей");
            yield return new TestCaseData("b", "бі");
            yield return new TestCaseData("c", "сі");
        }
    }
    */

    [TestFixture]
    public class SQLs_Test
    {
        //НЕ ЗАБУВАЙ КОМЕНТИТИ РЯДКИ З ЛОГІЮВАННЯМ В КОНТЕКСТІ МОДЕЛІ

        /// <summary>
        /// Connection String (contains path to .db file)
        /// </summary>
        string conStr = "Data Source=D:\\SELF-DEV\\HARD-SKILLS\\DEVELOPMENT\\PRACTICE\\MyProjects\\EWL FC\\EWL_Tests\\Test_SQLs.db;";

        [OneTimeSetUp]
        public void Setup()
        {
            SQLs.ConStr = conStr;
            //VocabularyContext.DoLogActions = false;
            TearDown();
        }



        #region [ Words ]

        [TestCaseSource(typeof(MyTestCases), "Words_Cases")]
        public void NewWord_Adding_Test(string engW, string uaW)
        {
            Assert.IsTrue(SQLs.TryAdd_Word_ToAllWords(engW, uaW),
                "Метод НЕ додав задане слово в Words");

            using VocabularyContext db = new(conStr);

            bool isAddedToWords = db.AllWords.Any(c => c.EngWord == engW && c.UaTranslation == uaW);
            Assert.IsTrue(isAddedToWords,
                "Задане слово НЕ було додане в БД");

            bool isWordAddedToWordCategories = db.WordCategories.Any(c => c.WordId == 3);
            Assert.IsTrue(isWordAddedToWordCategories,
                "Задане слово не було додане до категорії '1' в WordCategories");
        }

        [TestCaseSource(typeof(MyTestCases), "Words_Cases")]
        public void TwoIdenticalWords_Adding_Test(string engW, string uaW)
        {
            Assert.IsTrue(SQLs.TryAdd_Word_ToAllWords(engW, uaW),
                "Метод НЕ додав задане слово в Words");
            Assert.IsFalse(SQLs.TryAdd_Word_ToAllWords(engW, uaW),
                "Метод додав задане слово в Words [а не повинен був]");
        }

        [TestCaseSource(typeof(MyTestCases), "Words_Cases")]
        public void LastWords_Removing_Test(string engW, string uaW)
        {
            var (anotherWId, anotherEngW, AnotherUaW) = (3, "candle", "свічка");
            SQLs.TryAdd_Word_ToAllWords(anotherEngW, AnotherUaW);   //Додавання першого слова
            SQLs.TryAdd_Word_ToAllWords(engW, uaW);                 //Додавання другого слова
            SQLs.Remove_LastWords_Permanently(1);                   //Видалення останнього слова

            using VocabularyContext db = new(conStr);

            //Перевірки
            bool isLastAddedWordRemovedFromWords = !db.AllWords.Any(c => c.EngWord == engW);
            Assert.IsTrue(isLastAddedWordRemovedFromWords, "Останнє слово НЕ було видалене");

            bool isAnotherWordNOTRemovedFromWords = db.AllWords.Any(c => c.EngWord == anotherEngW);
            Assert.IsTrue(isAnotherWordNOTRemovedFromWords, "Інше слово було видалене [а не повинне бути]");

            bool isLastAddedWordRemovedFromWordCategories = !db.WordCategories.Any(c => c.WordId == 4);
            Assert.IsTrue(isLastAddedWordRemovedFromWordCategories, "Останнє слово НЕ було видалене з WordCategories");

            bool isAnotherWordRemovedFromWordCategories = db.WordCategories.Any(c => c.WordId == anotherWId);
            Assert.IsTrue(isAnotherWordRemovedFromWordCategories, "Інше слово було видалене з WordCategories [а не повинне бути]");
        }

        [TestCaseSource(typeof(MyTestCases), "Words_Cases")]
        public void Word_Removing_Test(string engW, string uaW)
        {
            var (anotherWId, anotherEngW, AnotherUaW) = (3, "candle", "свічка");
            SQLs.TryAdd_Word_ToAllWords(anotherEngW, AnotherUaW);   //Додавання першого слова
            SQLs.TryAdd_Word_ToAllWords(engW, uaW);                 //Додавання другого слова
            SQLs.Remove_Word_Permanently(4);                        //Видалення другого слова

            using VocabularyContext db = new(conStr);

            //Перевірки
            bool isLastAddedWordRemovedFromWords = !db.AllWords.Any(c => c.EngWord == engW);
            Assert.IsTrue(isLastAddedWordRemovedFromWords, "Друге слово НЕ було видалене");

            bool isAnotherWordNOTRemovedFromWords = db.AllWords.Any(c => c.EngWord == anotherEngW);
            Assert.IsTrue(isAnotherWordNOTRemovedFromWords, "Перше слово було видалене [а не повинне бути]");

            bool isLastAddedWordRemovedFromWordCategories = !db.WordCategories.Any(c => c.WordId == 4);
            Assert.IsTrue(isLastAddedWordRemovedFromWordCategories, "Друге слово НЕ було видалене з WordCategories");

            bool isAnotherWordRemovedFromWordCategories = db.WordCategories.Any(c => c.WordId == anotherWId);
            Assert.IsTrue(isAnotherWordRemovedFromWordCategories, "Перше слово було видалене з WordCategories [а не повинне бути]");
        }

        #endregion

        #region [ Categories ]

        #region Categories Adding

        [TestCaseSource(typeof(MyTestCases), "Categories_Cases")]
        public void NewCategory_Adding_Test(string categoryName)
        {
            Assert.IsTrue(SQLs.Add_NewCategory(categoryName),
                "Додавання нової категорії НЕ вдале");

            using VocabularyContext db = new(conStr);

            bool isCategoryAdded = db.Categories.Any(c => c.Name == categoryName);
            Assert.IsTrue(isCategoryAdded,
                "Нова категорія не з'явилася в Categories");
        }

        [TestCaseSource(typeof(MyTestCases), "Categories_Cases")]
        public void TwoIdenticalCategories_Adding_Test(string categoryName)
        {
            Assert.IsTrue(SQLs.Add_NewCategory(categoryName),
                "Додавання нової категорії НЕ вдале");
            Assert.IsFalse(SQLs.Add_NewCategory(categoryName),
                "Додавання нової категорії вдале [а не повинне бути]");
        }

        #endregion

        #region Categories Marking as Removed

        [TestCaseSource(typeof(MyTestCases), "Categories_Cases")]
        public void Category_MarkingAsRemoved_Test(string categoryName)
        {
            int categoryID = 3;
            SQLs.Add_NewCategory(categoryName);          //Додавання нової категорії (3-тя)
            SQLs.Set_CurrentCategory(categoryID);        //Встановлення поточної категорії - '3'

            using VocabularyContext db = new(conStr);

            //Перевірки
            Assert.IsTrue(SQLs.TryMarkAsRemoved_Category(categoryID),
            "Задана категорія НЕ була (позначена як) видалена");

            var category = db.Categories.First(c => c.CategoryId == categoryID);
            bool categoryIsMarkedAsDeleted = category.Deleted;
            Assert.IsTrue(categoryIsMarkedAsDeleted,
                "Значення поля 'Deleted' заданої категорії НЕ змінилося на '1'");

            Assert.AreEqual(1, db.Settings.First().CurrentCategoryId,
                "CurrentCategoryID в Settings НЕ змінилося на дефолтне '1'");

            DateTime actualDateTime = category.DeletedAt;
            Assert.IsTrue(($"{actualDateTime:yyyy-MM-dd HH:mm}" == $"{DateTime.Now:yyyy-MM-dd HH:mm}"),
                "Дата не встановлена або встановлена НЕвірно");
        }

        [TestCaseSource(typeof(MyTestCases), "Categories_Cases")]
        public void NonRemovableCategory_NOTMarkingAsRemoved_Test(string categoryName)
        {
            using VocabularyContext db = new(conStr);

            int categoryID = 3;
            //Додавання категорії, яку не можна видаляти
            db.Categories.Add(new Category { Name = categoryName, CanBeDeleted = false });
            db.SaveChanges();

            //Перевірки
            Assert.IsFalse(SQLs.TryMarkAsRemoved_Category(categoryID),
                "Дана категорія була (позначена як) видалена [а не повинна була]");

            bool categoryIsMarkedAsDeleted = db.Categories.First(c => c.CategoryId == categoryID).Deleted;
            Assert.IsFalse(categoryIsMarkedAsDeleted,
                "Значення поля 'Deleted' заданої категорії змінилося на '1' [а не повинно було]");
        }
        #endregion

        #region Categories Restoring from Deletion

        [TestCaseSource(typeof(MyTestCases), "Categories_Cases")]
        public void Category_Restoring_FromDeletion_Test(string categoryName)
        {
            int categoryID = 3;
            SQLs.Add_NewCategory(categoryName);           //Додавання нової категорії (3-тя)
            SQLs.Set_CurrentCategory(categoryID);         //Встановлення поточної категорії - '3'
            SQLs.TryMarkAsRemoved_Category(categoryID);   //Позначення категорії як "Видалена"

            SQLs.Restore_Category_FromDeletion(categoryID);   //Відновлення категорії з "Кошика"

            using VocabularyContext db = new(conStr);

            //var reader = DB.Get_DataReader($"SELECT Deleted FROM Categories WHERE CategoryID = {categoryID}");
            //reader.Read();
            bool categoryIsMarkedAsDeleted = db.Categories.First(c => c.CategoryId == categoryID).Deleted; //reader.GetInt32(0) == 1;
            Assert.IsFalse(categoryIsMarkedAsDeleted,
                "Значення поля 'Deleted' заданої категорії НЕ змінилося на '0'");

            Assert.AreEqual(1, SQLs.Get_CurrentCategory(),
                "CurrentCategoryID в Settings змінилося з дефолтного '1' на інше [а не повинне було]");
        }
        #endregion

        #region Categories Removing

        public void Category_MarkAsRemoved(int categoryID, string categoryName)
        {
            SQLs.Add_NewCategory(categoryName);           //Додавання нової категорії (3-тя)
            SQLs.TryAdd_Word_ToCategory(1, categoryID);   //Додавання першого слова до нової категорії
            SQLs.TryAdd_Word_ToCategory(2, categoryID);   //Додавання другого слова до нової категорії
            SQLs.TryMarkAsRemoved_Category(categoryID);   //Позначення категорії як "видалена"
        }

        [TestCaseSource(typeof(MyTestCases), "Categories_Cases")]
        public void RecentlyMarkedCategories_Removing_Test(string categoryName)
        {
            int categoryID = 3;
            Category_MarkAsRemoved(categoryID, categoryName);
            SQLs.FindAndRemove_LongMarkedCategories(3);

            using VocabularyContext db = new();

            //Перевірки
            bool isRecentlyMarkedCategoryWordsDeleted = !db.WordCategories.Any(c => c.CategoryId == categoryID);
            Assert.IsFalse(isRecentlyMarkedCategoryWordsDeleted, 
                "Слова даної категорії видалені з WordCategory [а НЕ повинні бути]");

            bool isRecentlyMarkedCategoryDeleted = !db.Categories.Any(c => c.CategoryId == categoryID);
            Assert.IsFalse(isRecentlyMarkedCategoryDeleted, 
                "Дана категорія видалена з Categories [а НЕ повинна бути]");
        }

        [TestCaseSource(typeof(MyTestCases), "Categories_Cases")]
        public void LongMarkedCategories_Removing_Test(string categoryName)
        {
            int categoryID = 3;
            Category_MarkAsRemoved(categoryID, categoryName);

            using VocabularyContext db = new();

            //Зміна дати (позначення як) видалення даної категорії
            db.Categories.First(c => c.CategoryId == categoryID).DeletedAt = new DateTime(2023, 01, 01);
            db.SaveChanges();
            SQLs.FindAndRemove_LongMarkedCategories(3);

            //Перевірка
            bool isLongMarkedCategoryWordsDeleted = !db.WordCategories.Any(c => c.CategoryId == categoryID);
            Assert.IsTrue(isLongMarkedCategoryWordsDeleted,
                "Слова даної категорії НЕ видалені з WordCategory");

            bool isLongMarkedCategoryDeleted = !db.Categories.Any(c => c.CategoryId == categoryID);
            Assert.IsTrue(isLongMarkedCategoryDeleted,
                "Дана категорія НЕ видалена з Categories");
        }
        #endregion

        #endregion

        #region [ WordCategories ]

        #region Adding words to category

        [TestCase(1)]
        [TestCase(2)]
        public void Word_Adding_ToCategory_Test(int wordID)
        {
            int anotherCategoryID = 2;

            using VocabularyContext db = new();

            //Перевірки
            Assert.IsTrue(SQLs.TryAdd_Word_ToCategory(wordID, anotherCategoryID), 
                "Метод НЕ додав слово до категорії '2'");

            bool isAddedToCategory2 = db.WordCategories.Any(wc => wc.WordId == wordID &&  wc.CategoryId == anotherCategoryID);
            Assert.IsTrue(isAddedToCategory2, "Слово НЕ з'явилося в категорії '2'");
        }

        [TestCase(2, 2)]
        public void TwoIdenticalWords_Adding_ToCategory_Test(int anotherWordID, int anotherCategoryID)
        {
            Assert.IsTrue(SQLs.TryAdd_Word_ToCategory(anotherWordID, anotherCategoryID), 
                "Метод НЕ додав слово до категорії '2'");
            Assert.IsFalse(SQLs.TryAdd_Word_ToCategory(anotherWordID, anotherCategoryID), 
                "Метод додав ІДЕНТИЧНЕ слово до категорії '2' [а не повинен]");
        }

        /// <summary>
        /// Перевіряє чи виникне виключення якщо додати до категорії слово з неправильним номером wordID чи categoryID
        /// </summary>
        /// <param name="invalidNumber">неправильний номер для wordID чи categoryID</param>
        [TestCase(0)]
        [TestCase(-2)]
        public void InvalidNumber_Word_Adding_ToCategory_Test(int invalidNumber)
        {
            int validWordID = 2;
            int validCategoryID = 2;

            TestDelegate AddValidWordIDToInvalidCategoryID = () => SQLs.TryAdd_Word_ToCategory(validWordID, invalidNumber);
            Assert.Catch(typeof(ArgumentException), AddValidWordIDToInvalidCategoryID,
                "Тут повинне виникати виключення, а не виникає");

            TestDelegate AddInvalidWordIDToValidCategoryID = () => SQLs.TryAdd_Word_ToCategory(invalidNumber, validCategoryID);
            Assert.Catch(typeof(ArgumentException), AddInvalidWordIDToValidCategoryID,
                "Тут повинне виникати виключення, а не виникає");

            TestDelegate AddInvalidWordIDToInvalidCategoryID = () => SQLs.TryAdd_Word_ToCategory(invalidNumber, invalidNumber);
            Assert.Catch(typeof(ArgumentException), AddInvalidWordIDToInvalidCategoryID,
                "Тут повинне виникати виключення, а не виникає");
        }

        #endregion

        #region Removing words from category

        [TestCase(1)]
        [TestCase(2)]
        public void LastAddedWord_Removing_FromWordCategories_Test(int count)
        {
            int categoryID = 2;
            for (int i = 1; i <= count; i++)
                SQLs.TryAdd_Word_ToCategory(i, categoryID);    //Додавання слова(-ів) до іншої категорії
            SQLs.Remove_LastWords_FromCategory(count);         //Видалення останнього(-іх) доданого до іншої категорії слова з WordCategories

            using VocabularyContext db = new();

            int WordsCount = 2;
            for (int i = 1; i <= WordsCount; i++)
            {
                if (i <= count)
                {
                    bool isLastAddedWordRemovedFromWords = !db.WordCategories.Any(wc => wc.WordId == i && wc.CategoryId == 2);
                        //!DB.Get_DataReader($"SELECT * FROM WordCategories WHERE WordID = {i} AND CategoryID = 2").HasRows;
                    Assert.IsTrue(isLastAddedWordRemovedFromWords, "Останні додані слова НЕ були видалені");
                }
                else
                {
                    bool isAnotherWordNOTRemovedFromWords = db.WordCategories.Any(wc => wc.WordId == i && wc.CategoryId == 1);
                        //DB.Get_DataReader($"SELECT * FROM WordCategories WHERE WordID = {i} AND CategoryID = 1").HasRows;
                    Assert.IsTrue(isAnotherWordNOTRemovedFromWords, "Інші слова були видалені [а не повинні бути]");
                }
            }
        }

        [TestCase(1)]
        [TestCase(2)]
        public void Word_Removing_FromWordCategories_Test(int wordID)
        {
            int categoryID = 2;                                    //Номер неосновної категорії
            SQLs.TryAdd_Word_ToCategory(wordID, categoryID);       //Додавання слова(-ів) до іншої категорії

            Assert.Catch<ArgumentException>(() => SQLs.Remove_Word_FromCategory(wordID, 1), 
                "Тут повинне виникати виключення, а не виникає");  //Спроба видалення слова з основної категорії

            using VocabularyContext db = new();

            SQLs.Remove_Word_FromCategory(wordID, categoryID);     //Видалення слова з неосновної категорії
            bool isWordRemovedFromAnotherCategory = !db.WordCategories.Any(wc => wc.WordId == wordID && wc.CategoryId == 2);
            Assert.IsTrue(isWordRemovedFromAnotherCategory, "Слово НЕ було видалене з НЕосновної категорії");
        }

        #endregion

        #region Getting Words from Category

        /// <summary>
        /// Додавання слів до БД (й половини з них до побічної категорії '2')
        /// </summary>
        /// <param name="wordCount">Кількість слів</param>
        void Words_Adding_ToDB(int wordCount)
        {
            int anotherCategoryID = 2;
            int alreadyAddedWordsCount = 2;

            for (int i = 0; i < wordCount; i++)
                SQLs.TryAdd_Word_ToAllWords($"{i + 1}", "i + 1");
            for (int i = 0; i < wordCount + alreadyAddedWordsCount; i++)
                if (i % 2 == 0)
                    SQLs.TryAdd_Word_ToCategory(i + 1, anotherCategoryID);
        }

        [TestCase(4)]
        [TestCase(6)]
        public void Words_Getting_FromMainCategory_Test(int addedWordCount)
        {
            int getWordsCount = 4;
            int categoryID = 1;
            Words_Adding_ToDB(addedWordCount);

            var allWFromCategory = SQLs.Get_Words_FromCategory(categoryID);
            Assert.AreEqual(addedWordCount + 2, allWFromCategory.Count, 
                $"Отриманих слів має бути {addedWordCount + 2} а не {allWFromCategory.Count}");

            var countWFromCategory = SQLs.Get_Words_FromCategory(categoryID, getWordsCount);
            Assert.AreEqual(getWordsCount, countWFromCategory.Count, 
                $"Отриманих слів має бути {getWordsCount} а не {allWFromCategory.Count}");
        }

        [TestCase(4)]
        [TestCase(6)]
        public void Words_Getting_FromAnotherCategory_Test(int addedWordCount)
        {
            int getWordsCount = 2;
            int categoryID = 2;
            Words_Adding_ToDB(addedWordCount);

            var allWFromCategory = SQLs.Get_Words_FromCategory(categoryID);
            //int addedWordCount
            Assert.AreEqual((int)Math.Round(((double)addedWordCount + 2)/2, MidpointRounding.AwayFromZero), allWFromCategory.Count,
                $"Отриманих слів має бути {addedWordCount + 2} а не {allWFromCategory.Count}");

            var countWFromCategory = SQLs.Get_Words_FromCategory(categoryID, getWordsCount);
            Assert.AreEqual(getWordsCount, countWFromCategory.Count,
                $"Отриманих слів має бути {addedWordCount + 2} а не {allWFromCategory.Count}");   
        }

        [TestCase(4)]
        [TestCase(6)]
        public void Words_NOTGetting_FromAnotherCategory_Test(int addedWordCount)
        {
            Words_Adding_ToDB(addedWordCount);
            int nonexistentWordCount = -2;
            TestDelegate GetWordsFromNonexistentCategory = () => SQLs.Get_Words_FromCategory(2, nonexistentWordCount);

            Assert.Catch(typeof(ArgumentException), GetWordsFromNonexistentCategory, 
                "Тут повинне виникати виключення, а не виникає");
        }

        #endregion

        #endregion


        #region [ Settings ]

        #region Setting Current category

        [TestCase(2)]
        [TestCase(1)]
        public void CurrentCategory_SettingAndGetting_Test(int categoryID)
        {
            SQLs.Set_CurrentCategory(categoryID);        //Налаштування значення CurrentCategoryID в Settings

            using VocabularyContext db = new(conStr);

            //Перевірки
            var actualCurrentCategoryID = db.Settings.First(s => s.SettingsId == 1).CurrentCategoryId;
            Assert.AreEqual(categoryID, actualCurrentCategoryID,
                "CurrentCategoryID НЕ встановлене із необхідним значенням");

            int gettedCurrentCategoryID = SQLs.Get_CurrentCategory();   //Отримання значення CurrentCategoryID в Settings
            int expectedCurrentCategoryID = actualCurrentCategoryID;    //зміна призначення змінної
            Assert.AreEqual(expectedCurrentCategoryID, gettedCurrentCategoryID,
                "Отримане значення CurrentCategoryID - НЕ вірне");
        }

        [Test]
        public void AllCategories_Getting_Test()
        {
            var categories = SQLs.Get_Categories();
            Assert.AreEqual("AllWords", categories[0].Name,
                "Отриманий список інформації про категорії - НЕ вірний");
        }
        #endregion

        #region Setting Current category



        #endregion

        #endregion

        //TODO - Додавати ТЕСТИ ...






        [TearDown]
        public void TearDown()
        {
            using VocabularyContext db = new();
            db.WordCategories.RemoveRange(db.WordCategories.Skip(2));
            db.AllWords.RemoveRange(db.AllWords.Skip(2));
            db.Categories.RemoveRange(db.Categories.Skip(2));
            db.SaveChanges();
        }
    }
}